<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spring Boot REST ç¤ºä¾‹</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Segoe UI Symbol'; margin: 2rem; }
    h1 { margin-top: 0; }
    label { display:block; margin:.5rem 0 .25rem; }
    input { padding:.4rem; width: 260px; }
    button { padding:.5rem 1rem; margin-top: .75rem; }
    pre { background:#f6f8fa; padding:1rem; border:1px solid #eaecef; overflow:auto; }
    .row { display:flex; gap:2rem; flex-wrap:wrap; }
    .card { border:1px solid #eaecef; padding:1rem; border-radius:6px; max-width:420px; }
    a { word-break: break-all; }
  </style>
  <script>
    async function sendJson() {
      const payload = {
        name: document.getElementById('name').value || null,
        age: document.getElementById('age').value ? Number(document.getElementById('age').value) : null,
        email: document.getElementById('email').value || null
      };
      const out = document.getElementById('output');
      out.textContent = 'å‘é€ä¸­...';
      try {
        const res = await fetch('/api/echo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        out.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        out.textContent = 'è¯·æ±‚å¤±è´¥: ' + e;
      }
    }
  </script>
  </head>
  <body>
    <h1>Spring Boot REST æ³¨è§£ç¤ºä¾‹</h1>
    <p>ç¤ºä¾‹æ¶µç›–ï¼š<code>@RestController</code>ã€<code>@RequestMapping</code>ã€<code>@GetMapping</code>ã€<code>@PostMapping</code>ã€<code>@PathVariable</code>ã€<code>@RequestParam</code>ã€<code>@RequestBody</code>ã€‚</p>

    <div class="row">
      <div class="card">
        <h2>@RequestParam /hello</h2>
        <p>GET ç¤ºä¾‹ï¼šæ ¹æ® <code>name</code> å‚æ•°é—®å€™ã€‚</p>
        <p>
          URLï¼š<a href="/api/hello?name=Spring">/api/hello?name=Spring</a>
        </p>
      </div>

      <div class="card">
        <h2>@PathVariable /user/{id}</h2>
        <p>GET ç¤ºä¾‹ï¼šè·¯å¾„ä¸­æºå¸¦ <code>id</code>ã€‚</p>
        <p>
          URLï¼š<a href="/api/user/123">/api/user/123</a>
        </p>
      </div>

      <div class="card">
        <h2>@RequestBody /echo</h2>
        <p>POST ç¤ºä¾‹ï¼šåœ¨æµè§ˆå™¨è¾“å…¥å‚æ•°åï¼Œä»¥ JSON æ–¹å¼æäº¤å¹¶æ˜¾ç¤ºæœåŠ¡å™¨è¿”å›ã€‚</p>
        <label for="name">name</label>
        <input id="name" placeholder="ä¾‹å¦‚ï¼šAlice" />
        <label for="age">age</label>
        <input id="age" type="number" placeholder="ä¾‹å¦‚ï¼š20" />
        <label for="email">email</label>
        <input id="email" type="email" placeholder="ä¾‹å¦‚ï¼šalice@example.com" />
        <br/>
        <button onclick="sendJson()">POST åˆ° /api/echo</button>
      </div>

      <div class="card">
        <h2>æ”¯ä»˜ç¤ºä¾‹ /api/pay ï¼ˆå·¥å‚æ¨¡å¼ï¼‰</h2>
        <p>é€‰æ‹©æ”¯ä»˜æ–¹å¼å¹¶æäº¤æ¨¡æ‹Ÿæ”¯ä»˜è¯·æ±‚ã€‚</p>
        <label for="pay-method">method</label>
        <select id="pay-method">
          <option value="WECHAT">WECHAT</option>
          <option value="ALIPAY">ALIPAY</option>
          <option value="CREDIT_CARD">CREDIT_CARD</option>
        </select>
        <label for="order-id">orderId</label>
        <input id="order-id" placeholder="ä¾‹å¦‚ï¼šORDER-1001" />
        <label for="amount">amount</label>
        <input id="amount" type="number" step="0.01" placeholder="ä¾‹å¦‚ï¼š99.90" />
        <label for="currency">currency</label>
        <input id="currency" value="CNY" />
        <div id="card-extra" style="display:none;margin-top:.5rem;">
          <label for="card-no">cardNo</label>
          <input id="card-no" placeholder="4111111111111111" />
        </div>
        <div id="wechat-extra" style="display:none;margin-top:.5rem;">
          <label for="openid">openId</label>
          <input id="openid" placeholder="ç”¨æˆ· openId" />
        </div>
        <div id="alipay-extra" style="display:none;margin-top:.5rem;">
          <label for="alipay-user">alipayUserId</label>
          <input id="alipay-user" placeholder="æ”¯ä»˜å®ç”¨æˆ·ID" />
        </div>
        <br/>
        <button onclick="pay()">POST åˆ° /api/pay</button>
      </div>
    </div>

    <h2>å“åº”è¾“å‡º</h2>
    <pre id="output">ç­‰å¾…è¯·æ±‚...</pre>

    <hr/>
    <p>è¿è¡Œåº”ç”¨åï¼Œè®¿é—® <a href="/">http://localhost:8080/</a> æ‰“å¼€æ­¤é¡µé¢ã€‚</p>
  <script>
    const methodSel = document.getElementById('pay-method');
    methodSel && methodSel.addEventListener('change', () => {
      const m = methodSel.value;
      document.getElementById('card-extra').style.display = (m === 'CREDIT_CARD') ? 'block' : 'none';
      document.getElementById('wechat-extra').style.display = (m === 'WECHAT') ? 'block' : 'none';
      document.getElementById('alipay-extra').style.display = (m === 'ALIPAY') ? 'block' : 'none';
    });

    async function pay() {
      const method = document.getElementById('pay-method').value;
      const orderId = document.getElementById('order-id').value || null;
      const amount = document.getElementById('amount').value ? Number(document.getElementById('amount').value) : null;
      const currency = document.getElementById('currency').value || 'CNY';
      const extra = {};
      if (method === 'CREDIT_CARD') {
        extra.cardNo = document.getElementById('card-no').value || null;
      } else if (method === 'WECHAT') {
        extra.openId = document.getElementById('openid').value || null;
      } else if (method === 'ALIPAY') {
        extra.alipayUserId = document.getElementById('alipay-user').value || null;
      }
      const payload = { method, orderId, amount, currency, extra };
      const out = document.getElementById('output');
      out.textContent = 'æ”¯ä»˜è¯·æ±‚ä¸­...';
      try {
        const res = await fetch('/api/pay', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        out.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        out.textContent = 'è¯·æ±‚å¤±è´¥: ' + e;
      }
    }
  </script>

  <hr/>
    <h1>è½¬è´¦ä¸ JDBC ç”¨æˆ·ç®¡ç†</h1>
    <div class="row">
      <div class="card" style="min-width:420px;">
        <h2>è½¬è´¦é¢æ¿</h2>
        <div>
          <label>ç”¨æˆ· 1 (Alice) ä½™é¢</label>
          <div id="bal-1">åŠ è½½ä¸­...</div>
          <label>ç”¨æˆ· 2 (Bob) ä½™é¢</label>
          <div id="bal-2">åŠ è½½ä¸­...</div>
        </div>
        <hr/>
        <label for="from-id">From User ID</label>
        <input id="from-id" value="1" />
        <label for="to-id">To User ID</label>
        <input id="to-id" value="2" />
        <label for="amt">Amount</label>
        <input id="amt" type="number" step="0.01" value="100.00" />
        <br/>
        <button onclick="doTransfer()">æ‰§è¡Œè½¬è´¦</button>
        <div id="transfer-result" style="margin-top:.5rem;color:#333"></div>
      </div>
    </div>
  <p>æ”¯æŒä¸¤ç§å®ç°ï¼šåŸå§‹ JDBC ä¸ JdbcTemplateï¼ˆé€šè¿‡ä¸‹æ‹‰æ¡†é€‰æ‹©ï¼‰ã€‚</p>

  <div class="row">
    <div class="card" style="min-width:520px;">
      <h2>ç”¨æˆ·åˆ—è¡¨</h2>
      <label for="backend">Backend</label>
      <select id="backend">
        <option value="jt" selected>JdbcTemplate</option>
        <option value="raw">åŸå§‹JDBC</option>
      </select>
      <br/>
      <button onclick="reloadUsers()">åˆ·æ–°åˆ—è¡¨</button>
      <div id="users-area" style="margin-top:1rem;">
        <em>å°šæœªåŠ è½½</em>
      </div>
    </div>

    <div class="card">
      <h2>æ–°å¢ç”¨æˆ·</h2>
      <label for="new-name">name</label>
      <input id="new-name" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰" />
      <label for="new-age">age</label>
      <input id="new-age" type="number" placeholder="ä¾‹å¦‚ï¼š30" />
      <label for="new-email">email</label>
      <input id="new-email" type="email" placeholder="ä¾‹å¦‚ï¼šzhangsan@example.com" />
      <br/>
      <button onclick="createUser()">POST /api/users</button>
      <div id="create-tip"></div>
    </div>

    <div class="card">
      <h2>æ›´æ–°ç”¨æˆ·</h2>
      <label for="upd-id">id</label>
      <input id="upd-id" type="number" placeholder="è¦æ›´æ–°çš„ç”¨æˆ·ID" />
      <label for="upd-name">name</label>
      <input id="upd-name" placeholder="æ–°åç§°" />
      <label for="upd-age">age</label>
      <input id="upd-age" type="number" placeholder="æ–°å¹´é¾„ï¼ˆå¯ç©ºï¼‰" />
      <label for="upd-email">email</label>
      <input id="upd-email" type="email" placeholder="æ–°é‚®ç®±ï¼ˆå¯ç©ºï¼‰" />
      <br/>
      <button onclick="updateUser()">PUT /api/users/{id}</button>
      <div id="update-tip"></div>
    </div>
  </div>

  <script>
    async function loadBalances() {
      try {
        const r1 = await fetch('/api/users/1');
        const u1 = await r1.json();
        document.getElementById('bal-1').textContent = u1.balance ?? 'N/A';
      } catch (e) {
        document.getElementById('bal-1').textContent = 'åŠ è½½å¤±è´¥';
      }
      try {
        const r2 = await fetch('/api/users/2');
        const u2 = await r2.json();
        document.getElementById('bal-2').textContent = u2.balance ?? 'N/A';
      } catch (e) {
        document.getElementById('bal-2').textContent = 'åŠ è½½å¤±è´¥';
      }
    }

    async function doTransfer() {
      const from = Number(document.getElementById('from-id').value);
      const to = Number(document.getElementById('to-id').value);
      const amount = Number(document.getElementById('amt').value);
      const resEl = document.getElementById('transfer-result');
      resEl.textContent = 'æäº¤ä¸­...';
      try {
        const r = await fetch('/api/transfer', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ fromUserId: from, toUserId: to, amount: amount })
        });
        if (!r.ok) {
          const txt = await r.text();
          resEl.textContent = `å¤±è´¥: ${r.status} ${txt}`;
        } else {
          const txt = await r.text();
          resEl.textContent = 'æˆåŠŸ: ' + txt;
        }
      } catch (e) {
        resEl.textContent = 'è¯·æ±‚å¤±è´¥: ' + e;
      }
      await loadBalances();
    }

    // load balances on page load
    window.addEventListener('load', () => { loadBalances(); });

    function renderUsers(list) {
      const area = document.getElementById('users-area');
      if (!list || list.length === 0) {
        area.innerHTML = '<em>æš‚æ— æ•°æ®</em>';
        return;
      }
      const rows = list.map(u => `
        <tr>
          <td>${u.id}</td>
          <td>${u.name ?? ''}</td>
          <td>${u.age ?? ''}</td>
          <td>${u.email ?? ''}</td>
          <td>${u.createdAt ?? ''}</td>
          <td>
            <button onclick="prefill(${u.id}, '${encodeURIComponent(u.name ?? '')}', '${u.age ?? ''}', '${encodeURIComponent(u.email ?? '')}')">ç¼–è¾‘</button>
            <button onclick="deleteUser(${u.id})">åˆ é™¤</button>
          </td>
        </tr>`).join('');
      area.innerHTML = `
        <table border="1" cellspacing="0" cellpadding="6">
          <thead>
            <tr><th>ID</th><th>Name</th><th>Age</th><th>Email</th><th>CreatedAt</th><th>æ“ä½œ</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    function selectedBackend() {
      return document.getElementById('backend')?.value || 'jt';
    }

    async function reloadUsers() {
      const area = document.getElementById('users-area');
      area.innerHTML = 'åŠ è½½ä¸­...';
      try {
        const res = await fetch('/api/users?backend=' + selectedBackend());
        const data = await res.json();
        renderUsers(data);
      } catch (e) {
        area.innerHTML = 'åŠ è½½å¤±è´¥: ' + e;
      }
    }

    async function createUser() {
      const name = document.getElementById('new-name').value;
      const ageVal = document.getElementById('new-age').value;
      const email = document.getElementById('new-email').value || null;
      const age = ageVal ? Number(ageVal) : null;
      const tip = document.getElementById('create-tip');
      tip.textContent = 'æäº¤ä¸­...';
      try {
        const res = await fetch('/api/users?backend=' + selectedBackend(), {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ name, age, email })
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        tip.textContent = 'åˆ›å»ºæˆåŠŸ';
        document.getElementById('new-name').value='';
        document.getElementById('new-age').value='';
        document.getElementById('new-email').value='';
        reloadUsers();
      } catch (e) { tip.textContent = 'åˆ›å»ºå¤±è´¥: ' + e; }
    }

    function prefill(id, nameEnc, age, emailEnc) {
      document.getElementById('upd-id').value = id;
      document.getElementById('upd-name').value = decodeURIComponent(nameEnc);
      document.getElementById('upd-age').value = age ?? '';
      document.getElementById('upd-email').value = decodeURIComponent(emailEnc);
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    async function updateUser() {
      const id = document.getElementById('upd-id').value;
      const name = document.getElementById('upd-name').value;
      const ageVal = document.getElementById('upd-age').value;
      const email = document.getElementById('upd-email').value || null;
      const age = ageVal ? Number(ageVal) : null;
      const tip = document.getElementById('update-tip');
      tip.textContent = 'æäº¤ä¸­...';
      try {
        const res = await fetch('/api/users/' + id + '?backend=' + selectedBackend(), {
          method: 'PUT', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ name, age, email })
        });
        if (res.status === 404) { tip.textContent = 'æœªæ‰¾åˆ°è¯¥ID'; return; }
        if (!res.ok) throw new Error('HTTP ' + res.status);
        tip.textContent = 'æ›´æ–°æˆåŠŸ';
        reloadUsers();
      } catch (e) { tip.textContent = 'æ›´æ–°å¤±è´¥: ' + e; }
    }

    async function deleteUser(id) {
      if (!confirm('ç¡®è®¤åˆ é™¤ID=' + id + ' ?')) return;
      try {
        const res = await fetch('/api/users/' + id + '?backend=' + selectedBackend(), { method: 'DELETE' });
        if (res.status === 404) { alert('æœªæ‰¾åˆ°è¯¥ID'); return; }
        if (!res.ok) throw new Error('HTTP ' + res.status);
        reloadUsers();
      } catch (e) { alert('åˆ é™¤å¤±è´¥: ' + e); }
    }

    // auto load users
    reloadUsers();
  </script>

  <hr/>
  <h1>AOPæ€§èƒ½ç›‘æ§é¢æ¿</h1>
  <div class="row">
    <div class="card" style="min-width:500px;">
      <h2>å®æ—¶æ€§èƒ½ç»Ÿè®¡</h2>
      <div id="metrics-summary">
        <em>åŠ è½½ä¸­...</em>
      </div>
      <button onclick="loadMetrics()">åˆ·æ–°æ€§èƒ½æ•°æ®</button>
    </div>

    <div class="card" style="min-width:600px;">
      <h2>è¯¦ç»†æ€§èƒ½æŒ‡æ ‡</h2>
      <div id="metrics-details">
        <em>åŠ è½½ä¸­...</em>
      </div>
    </div>
  </div>

  <div class="card" style="max-width:1000px;">
    <h2>AOPåŠŸèƒ½æµ‹è¯•</h2>
    <p>æµ‹è¯•AOPåˆ‡é¢çš„å¼‚å¸¸å¤„ç†ã€æ—¥å¿—è®°å½•å’Œæ€§èƒ½ç»Ÿè®¡åŠŸèƒ½ï¼š</p>
    
    <div style="display:flex; gap:1rem; flex-wrap:wrap;">
      <button onclick="testNormalRequest()">æµ‹è¯•æ­£å¸¸è¯·æ±‚</button>
      <button onclick="testSlowRequest()">æµ‹è¯•æ…¢è¯·æ±‚ï¼ˆæ¨¡æ‹Ÿ1ç§’å»¶è¿Ÿï¼‰</button>
      <button onclick="testExceptionRequest()">æµ‹è¯•å¼‚å¸¸è¯·æ±‚</button>
      <button onclick="testNullPointerException()">æµ‹è¯•ç©ºæŒ‡é’ˆå¼‚å¸¸</button>
    </div>
    
    <div style="margin-top:1rem;">
      <h3>æµ‹è¯•ç»“æœï¼š</h3>
      <pre id="aop-test-result" style="min-height:100px;">ç­‰å¾…æµ‹è¯•...</pre>
    </div>
  </div>

  <script>
    // åŠ è½½æ€§èƒ½ç»Ÿè®¡æ¦‚è§ˆ
    async function loadMetrics() {
      try {
        const [summaryRes, detailsRes] = await Promise.all([
          fetch('/api/metrics/summary'),
          fetch('/api/metrics')
        ]);
        
        const summary = await summaryRes.json();
        const details = await detailsRes.json();
        
        // æ›´æ–°æ¦‚è§ˆ
        document.getElementById('metrics-summary').innerHTML = `
          <p><strong>æ€»æ–¹æ³•æ•°:</strong> ${summary.totalMethods}</p>
          <p><strong>æ€»è°ƒç”¨æ¬¡æ•°:</strong> ${summary.totalCalls}</p>
          <p><strong>æ€»æ‰§è¡Œæ—¶é—´:</strong> ${summary.totalTime}</p>
          <p><strong>å¹³å‡æ‰§è¡Œæ—¶é—´:</strong> ${summary.overallAverage}</p>
        `;
        
        // æ›´æ–°è¯¦ç»†æŒ‡æ ‡
        if (details.metrics && Object.keys(details.metrics).length > 0) {
          let detailsHtml = '<table border="1" cellspacing="0" cellpadding="6" style="width:100%;">';
          detailsHtml += '<tr><th>æ–¹æ³•å</th><th>è°ƒç”¨æ¬¡æ•°</th><th>æ€»è€—æ—¶</th><th>å¹³å‡è€—æ—¶</th><th>æœ€å°è€—æ—¶</th><th>æœ€å¤§è€—æ—¶</th></tr>';
          
          Object.entries(details.metrics).forEach(([methodName, metrics]) => {
            detailsHtml += `
              <tr>
                <td><code>${methodName}</code></td>
                <td>${metrics.callCount}</td>
                <td>${metrics.totalTime}ms</td>
                <td>${metrics.averageTime}</td>
                <td>${metrics.minTime}</td>
                <td>${metrics.maxTime}</td>
              </tr>
            `;
          });
          
          detailsHtml += '</table>';
          document.getElementById('metrics-details').innerHTML = detailsHtml;
        } else {
          document.getElementById('metrics-details').innerHTML = '<p>æš‚æ— æ€§èƒ½æ•°æ®</p>';
        }
      } catch (error) {
        document.getElementById('metrics-summary').innerHTML = '<p style="color:red;">åŠ è½½å¤±è´¥: ' + error + '</p>';
        document.getElementById('metrics-details').innerHTML = '<p style="color:red;">åŠ è½½å¤±è´¥: ' + error + '</p>';
      }
    }

    // æµ‹è¯•æ­£å¸¸è¯·æ±‚
    async function testNormalRequest() {
      const resultEl = document.getElementById('aop-test-result');
      resultEl.textContent = 'æµ‹è¯•ä¸­...';
      
      try {
        const startTime = Date.now();
        const response = await fetch('/api/hello?name=AOPTest');
        const endTime = Date.now();
        const data = await response.json();
        
        resultEl.textContent = `âœ… æ­£å¸¸è¯·æ±‚æµ‹è¯•æˆåŠŸ\n` +
          `è¯·æ±‚è€—æ—¶: ${endTime - startTime}ms\n` +
          `å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}\n\n` +
          `ğŸ“ è¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ç¡®è®¤AOPåˆ‡é¢æ˜¯å¦è®°å½•äº†æ–¹æ³•æ‰§è¡Œä¿¡æ¯`;
      } catch (error) {
        resultEl.textContent = `âŒ æ­£å¸¸è¯·æ±‚æµ‹è¯•å¤±è´¥: ${error}`;
      }
      
      // åˆ·æ–°æ€§èƒ½æ•°æ®
      setTimeout(loadMetrics, 500);
    }

    // æµ‹è¯•æ…¢è¯·æ±‚
    async function testSlowRequest() {
      const resultEl = document.getElementById('aop-test-result');
      resultEl.textContent = 'æµ‹è¯•ä¸­...';
      
      try {
        const startTime = Date.now();
        const response = await fetch('/api/user/999?slow=true');
        const endTime = Date.now();
        const data = await response.json();
        
        resultEl.textContent = `â±ï¸ æ…¢è¯·æ±‚æµ‹è¯•å®Œæˆ\n` +
          `è¯·æ±‚è€—æ—¶: ${endTime - startTime}ms\n` +
          `å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}\n\n` +
          `ğŸ“ è¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ç¡®è®¤AOPåˆ‡é¢æ˜¯å¦è®°å½•äº†æ…¢æ–¹æ³•è­¦å‘Š`;
      } catch (error) {
        resultEl.textContent = `âŒ æ…¢è¯·æ±‚æµ‹è¯•å¤±è´¥: ${error}`;
      }
      
      // åˆ·æ–°æ€§èƒ½æ•°æ®
      setTimeout(loadMetrics, 500);
    }

    // æµ‹è¯•å¼‚å¸¸è¯·æ±‚
    async function testExceptionRequest() {
      const resultEl = document.getElementById('aop-test-result');
      resultEl.textContent = 'æµ‹è¯•ä¸­...';
      
      try {
        const response = await fetch('/api/user/exception');
        const data = await response.json();
        
        resultEl.textContent = `âš ï¸ å¼‚å¸¸è¯·æ±‚æµ‹è¯•å®Œæˆ\n` +
          `HTTPçŠ¶æ€ç : ${response.status}\n` +
          `å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}\n\n` +
          `ğŸ“ è¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ç¡®è®¤AOPåˆ‡é¢æ˜¯å¦è®°å½•äº†å¼‚å¸¸ä¿¡æ¯`;
      } catch (error) {
        resultEl.textContent = `âŒ å¼‚å¸¸è¯·æ±‚æµ‹è¯•å¤±è´¥: ${error}`;
      }
      
      // åˆ·æ–°æ€§èƒ½æ•°æ®
      setTimeout(loadMetrics, 500);
    }

    // æµ‹è¯•ç©ºæŒ‡é’ˆå¼‚å¸¸
    async function testNullPointerException() {
      const resultEl = document.getElementById('aop-test-result');
      resultEl.textContent = 'æµ‹è¯•ä¸­...';
      
      try {
        const response = await fetch('/api/user/null');
        const data = await response.json();
        
        resultEl.textContent = `âš ï¸ ç©ºæŒ‡é’ˆå¼‚å¸¸æµ‹è¯•å®Œæˆ\n` +
          `HTTPçŠ¶æ€ç : ${response.status}\n` +
          `å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}\n\n` +
          `ğŸ“ è¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ç¡®è®¤AOPåˆ‡é¢æ˜¯å¦è®°å½•äº†ç©ºæŒ‡é’ˆå¼‚å¸¸ä¿¡æ¯`;
      } catch (error) {
        resultEl.textContent = `âŒ ç©ºæŒ‡é’ˆå¼‚å¸¸æµ‹è¯•å¤±è´¥: ${error}`;
      }
      
      // åˆ·æ–°æ€§èƒ½æ•°æ®
      setTimeout(loadMetrics, 500);
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ€§èƒ½æ•°æ®
    window.addEventListener('load', () => {
      setTimeout(loadMetrics, 1000);
    });

    // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°æ€§èƒ½æ•°æ®
    setInterval(loadMetrics, 30000);
  </script>
  </body>
</html>
